

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.jpg">
  <link rel="icon" href="/img/avatar.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="JointHex">
  <meta name="keywords" content="">
  
    <meta name="description" content="阅读《C++ Concurrency in Action》时记录下的笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="C++ Concurrency in Action笔记">
<meta property="og:url" content="https://jhex-git.github.io/posts/3350115786/index.html">
<meta property="og:site_name" content="JointHex的技术分享站">
<meta property="og:description" content="阅读《C++ Concurrency in Action》时记录下的笔记">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-09-30T09:18:00.000Z">
<meta property="article:modified_time" content="2024-03-10T06:12:37.742Z">
<meta property="article:author" content="JointHex">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="长篇笔记">
<meta property="article:tag" content="多线程">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>C++ Concurrency in Action笔记 - JointHex的技术分享站</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"jhex-git.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.1.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>JointHex的技术分享站</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/NPR.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="C++ Concurrency in Action笔记"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-09-30 17:18" pubdate>
          2022年9月30日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          2.1k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          18 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">C++ Concurrency in Action笔记</h1>
            
            
              <div class="markdown-body">
                
                <blockquote>
<p>阅读《C++ Concurrency in Action》时记录下的笔记</p>
</blockquote>
<span id="more"></span>
<p>std::thread works with any callable type, e.g.. a class instance with
operator().</p>
<p>注意避免C++'s most vexing
parse，也就是类的无参构造时，应像下面这样写。</p>
<p><img
src="https://raw.githubusercontent.com/JHex-git/images/master/image/2023/02/22/image-20220930172352334.png" srcset="/img/loading.gif" lazyload /></p>
<p>如果没有定义std::thread该如何运行，std::thread的destructor会在调用std::terminate，所以应在其析构前决定它是join还是detach。</p>
<p>用RAII保证它exception-safe。</p>
<p><img
src="https://raw.githubusercontent.com/JHex-git/images/master/image/2023/02/22/image-20221001133936647.png" srcset="/img/loading.gif" lazyload /></p>
<h3 id="stdthread的参数传递">std::thread的参数传递</h3>
<p>默认情况下，传给std::thread的内容会被copy或move到std::thread对象内，在callable
object被调用时才会被以rvalue形式进一步传给函数。所以当函数的参数为非const的reference时，编译器将报错。</p>
<p>如果想要引用当前的变量，可以使用std::ref。</p>
<p>如果想要在其他线程执行成员函数，可以用如下方式。</p>
<p><img
src="https://raw.githubusercontent.com/JHex-git/images/master/image/2023/02/22/image-20221001120705487.png" srcset="/img/loading.gif" lazyload /></p>
<p>如果成员函数有参数，可以跟在后面。</p>
<p>可以用std::thread::hardware_concurrency()查看支持的线程数，但如果该信息不可用则会返回0。</p>
<p>注意创建线程时-1因为还有该线程自身。</p>
<blockquote>
<p>与迭代器有关的一系列函数</p>
<p>std::distance 给定两个迭代器之间的元素个数</p>
<p>std::advance 将给定迭代器移动指定距离</p>
<p>std::accumulate 两个迭代器之间的元素的和</p>
</blockquote>
<h3 id="identifying-threads">Identifying threads</h3>
<p>每个underlying的thread都有一个独特的编号，可以用std::thread::get_id()得到thread
object的id object，如果该thread object没有underlying
thread，那就会返回一个default-destructed的id object。</p>
<p>可以使用std::this_thread::get_id()得到当前thread的underlying
thread的id object。</p>
<p>std::thread::id是total order的</p>
<h2 id="sharing-data-between-threads">Sharing data between threads</h2>
<p>通过std::mutex实现。</p>
<p>std::mutex实际上并不是给数据加锁，而是给代码加锁，所有用同一个std::mutex锁住的代码段不能同时执行。</p>
<p>但这并不是说，当我们实现一个类时，只需要将会发生race或invariant
break的代码段加锁就不会出现问题。如果将需要保护的数据作为pointer、reference返回出去，或作为参数传递给函数，使用者并没有意识到这是多线程危险的，所以不会加锁，这就会导致问题。</p>
<p>Don’t pass pointers and references to protected data outside the
scope of the lock, whether by returning them from a function, storing
them in externally visible memory, or passing them as arguments to
user-supplied functions.</p>
<p>此外，当一个object在多个线程间被共享时，也可能出现问题。比如stack，其他线程在进行push、pop而有一线程在根据stack内元素个数进行不同的操作，即使使用了std::mutex，也可能会出现判断完了之后条件不成立的情况。</p>
<p><img
src="https://raw.githubusercontent.com/JHex-git/images/master/image/2023/02/22/image-20221001165519600.png" srcset="/img/loading.gif" lazyload /></p>
<h3 id="deadlock">Deadlock</h3>
<p><img
src="https://raw.githubusercontent.com/JHex-git/images/master/image/2023/02/22/image-20221001193352631.png" srcset="/img/loading.gif" lazyload /></p>
<p>上图代码中，如果第一个函数的第一行被一个线程执行，然后第二个函数的第一行被另一个执行，就出现了死锁。</p>
<p>deadlock造成的原因为不同函数中上锁顺序可能不同。为避免这点，C++提供了一个一次性上多个锁的机制，即std::lock。对于已经上锁的使用std::lock_guard需要在第二个参数传入std::adopt_lock，因为对已经上mutex锁的调用lock是未定义行为。</p>
<p>此外，可以统一锁的顺序。可以用hierarchy的概念对该顺序进行规定，每个锁在初始化时传入一个hierarchy，hierarchy大的锁必须在hierarchy小的锁前面lock。</p>
<p><img
src="https://raw.githubusercontent.com/JHex-git/images/master/image/2023/02/22/image-20221001220135746.png" srcset="/img/loading.gif" lazyload /></p>
<p>C++17的std::scoped_lock提供了更简单的实现，它类似于std::lock_guard，但是可以直接用于多个mutex。</p>
<p>死锁同样还可能在两个或多个thread互相等待彼此join时发生，所以写代码时应该避免这一点。</p>
<p>std::unique_lock可以用于mutex不立刻上锁的场景，通过第二个参数std::defer_lock，之后用std::lock上锁。但由于它需要额外的开销维护锁是否上了，效率并不是很高。owns_lock可以检测是否上锁。通常情况下，如果没有转移owner_ship的要求以及defer的需要，且在C++17以上，用scope_lock是更好的选择。</p>
<p>std::unique_lock支持手动解锁、加锁。</p>
<h3 id="locking-at-an-approporiate-granularity">Locking at an
approporiate granularity</h3>
<p>Unless the lock is intended to protect access to the file, don't do
any time-consuming activities like file I/O whilte holding a lock.</p>
<h2 id="alternative-facilities-for-protecting-shared-data">Alternative
facilities for protecting shared data</h2>
<h4 id="protecting-shared-data-during-initialization">Protecting shared
data during initialization</h4>
<p>C++11以后，static变量的初始化多线程安全。</p>
<p>可以用std::once_flag和std::call_once来确保初始化只进行一次。这样的做法往往比用std::mutex开销小许多。</p>
<p><img
src="https://raw.githubusercontent.com/JHex-git/images/master/image/2023/02/22/image-20221002093727847.png" srcset="/img/loading.gif" lazyload /></p>
<p><img
src="https://raw.githubusercontent.com/JHex-git/images/master/image/2023/02/22/image-20221002093653774.png" srcset="/img/loading.gif" lazyload /></p>
<h4 id="protecting-rarely-updated-data-structures">Protecting rarely
updated data structures</h4>
<p>C++14提供了std::shared_timed_mutex，C++17提供了std::shared_mutex，std::shared_timed_mutex提供了更多的功能，但是开销会稍有增加。</p>
<p>The performance is dependent on the number of processors involved and
the relative workloads of the reader and updater threads. It’s therefore
important to profile the performance of the code on the target system to
ensure that there’s a benefit to the additional complexity.</p>
<p>std::shared_mutex支持共享锁和互斥锁。std::lock_guard、std::unique_lock和std::mutex，提供exclusive
access。C++14提供的std::shared_lock用于加共享锁。</p>
<p>给有共享锁的加互斥锁和给有互斥锁的加共享锁都会阻塞。</p>
<h4 id="recursive-locking">Recursive locking</h4>
<p>当一个加锁的成员函数调用另一个加锁的成员函数时，可以用std::recursive_mutex代替std::mutex。但是这往往不是一个好的解决方案，因为第二个函数可能会在invariant
broken的情况下运行。一个更好的解决方案是写一个新的不加锁的成员函数，并仅在加锁的情况下调用该函数。</p>
<h2 id="synchronizing-concurrent-operations">Synchronizing concurrent
operations</h2>
<h3 id="waiting-for-an-event-or-other-condition">Waiting for an event or
other condition</h3>
<p>C++提供了std::condition_variable和std::condition_variable_any（more
general but less flexibility）.</p>
<p>condition_variable提供了wait方法，该方法接受一个std::unique_lock和一个函数。如果函数返回false就解开锁并且将当前thread变成blocked或waiting
state，直到这个condition_variable在另一个线程中被notify()。一旦notify，重新上锁并再一次调用函数检测。如果返回为true则保持上锁状态继续执行，否则同上。</p>
<p>使用notify_one从所有等待的线程中选一个响应，notify_all使得所有线程响应。</p>
<p>wait的一种简单实现如下。</p>
<p><img
src="https://raw.githubusercontent.com/JHex-git/images/master/image/2023/02/22/image-20221002140137979.png" srcset="/img/loading.gif" lazyload /></p>
<h3 id="waiting-for-one-off-events-with-futures">Waiting for one-off
events with futures</h3>
<p>std::future是move-only的，只能进行一次get操作。</p>
<p>用std::async</p>
<p>用std::packaged_task给function或callable
object绑定std::future。结合使用它与队列，可以给一个线程分配任务。</p>
<p><img
src="https://raw.githubusercontent.com/JHex-git/images/master/image/2023/02/22/image-20221002205038163.png" srcset="/img/loading.gif" lazyload /></p>
<p>用std::thread运行std::packaged_task，就可以通过它对应的std::future得到返回值。</p>
<hr />
<p>std::promise
object可以用get_future方法得到std::future，而std::promise
object可以通过set_value、set_exception设置值或异常作为std::future的get的返回内容。一旦设置，std::future就为ready。</p>
<hr />
<p>std::future中可以存放值或exception，在get时exception被重新抛出，但C++并没有规定重新抛出的exception是否和原本的一致，所以不同编译器实现可能有不同。</p>
<p><img
src="https://raw.githubusercontent.com/JHex-git/images/master/image/2023/02/22/image-20221003093419212.png" srcset="/img/loading.gif" lazyload /></p>
<p>如果已经知道要抛出的错误是什么，最好直接用下面的语句，因为它效率更高，更易读。</p>
<p><img
src="https://raw.githubusercontent.com/JHex-git/images/master/image/2023/02/22/image-20221003093558214.png" srcset="/img/loading.gif" lazyload /></p>
<p>如果std::promise没有set或std::packaged_task没有被call，那么它们析构的时候就会在关联的future中store
a std::future_error exception with an error code of
std::future_errc::broken_promise。</p>
<p>std::future只能有一个thread等待它的结果，std::shared_future支持多个。</p>
<hr />
<p>std::shared_future是copyable的，可以通过future.share()得到，也可以通过move
future得到。</p>
<h3 id="waiting-with-a-time-limit">Waiting with a time limit</h3>
<h4 id="clock">Clock</h4>
<p>std::chrono::system_clock：通常而言，这个时钟并不稳定，因为它会有一个自动校准的过程，这甚至可能导致后来的now小于之前的now。</p>
<p>std::chrono::steady_clock：这个时钟非常稳定。</p>
<p>std::chrono::high_resolution_clock：这个时钟的period最小，因而可以提供最高的精度。</p>
<p>some_clock::now()返回类型是some_clock::time_point。</p>
<p>some_clock::period是时钟周期typedef，单位秒，是std::ratio</p>
<h4 id="durations">Durations</h4>
<p>std::chrono::duration第一个模板参数表示用来存储该时间的数据类型，第二个参数为std::ratio，用来指定该单位duration的长度。</p>
<p>C++ 在std::chrono
namespace里提供了nanoseconds、microseconds、milliseconds、seconds、minutes、hours，它们都用足够大的integral类型表示duration。</p>
<p>C++14引入了std::chrono_literals
namespace，支持用后缀h、min、ms等表示duration。</p>
<p>对于整数，上面两种方式是等价的。</p>
<p>对于浮点数，如果关注范围和精度，应使用std::chorono::duration。</p>
<p>当不需要截断时，也即大的单位转小的单位，转换是隐式的。但反过来则需要显式转换。C++提供了std::chrono::duration_cast用于时间单位的转换。该转换是截断而不是取整。</p>
<p>使用wait_for</p>
<p>去掉单位的整数可以用.count()获得</p>
<hr />
<p>std::future::wait_for方法接受一个duration参数，返回类型为std::future_status，如果是timeout则说明等待时间到了，如果是ready说明future在ready状态，如果是deferred说明future的task在deferred状态。wait_for使用的是steady_clock。</p>
<h4 id="time-points">Time points</h4>
<p>std::chrono::time_point第一个模板参数为时钟类型，第二个为单位。</p>
<p>使用wait_until</p>
<p>如果只是等待固定的时间，应使用wait_until，因为它不存在虚假唤醒的问题，到达时间后自动唤醒，而wait_for则是隔一段时间唤醒一次检查条件。</p>
<p>std::condition_variable::wait_until返回类型为std::cv_status。</p>
<h4 id="functions-that-accept-timeouts">Functions that accept
timeouts</h4>
<p>std::future、std::condition_variable、std::this_thread::sleep_for、std::this_thread::sleep_until。</p>
<p>std::timed_mutex、std::recursive_timed_mutex、std::shared_timed_mutex支持try_lock_for和try_lock_until</p>
<h3 id="using-synchronization-of-operations-to-simplify-code">Using
synchronization of operations to simplify code</h3>
<h4 id="functional-programming-with-futures">Functional programming with
futures</h4>
<p>Functional
programming指函数和外部状态无关，只和传入的参数有关，且不会修改外部状态，即只要传入参数一致，得到的结果必然相同。这种范式非常容易改成并发。</p>
<h4 id="synchronizing-operations-with-message-passing">Synchronizing
operations with message passing</h4>
<p>CSP（Communicating Sequential Process）：没有shared
data，每个thread独立运行，只基于它受到的message。实现类似于有限状态机。</p>
<p><img
src="https://raw.githubusercontent.com/JHex-git/images/master/image/2023/02/22/image-20221003172609737.png" srcset="/img/loading.gif" lazyload /></p>
<p><img
src="https://raw.githubusercontent.com/JHex-git/images/master/image/2023/02/22/image-20221003172739758.png" srcset="/img/loading.gif" lazyload /></p>
<h4
id="continuation-style-concurrency-with-the-concurrency-ts">Continuation-style
concurrency with the Concurrency TS</h4>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E9%95%BF%E7%AF%87%E7%AC%94%E8%AE%B0/" class="category-chain-item">长篇笔记</a>
  
  
    <span>></span>
    
  <a href="/categories/%E9%95%BF%E7%AF%87%E7%AC%94%E8%AE%B0/C/" class="category-chain-item">C++</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/C/" class="print-no-link">#C++</a>
      
        <a href="/tags/%E9%95%BF%E7%AF%87%E7%AC%94%E8%AE%B0/" class="print-no-link">#长篇笔记</a>
      
        <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" class="print-no-link">#多线程</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>C++ Concurrency in Action笔记</div>
      <div>https://jhex-git.github.io/posts/3350115786/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>JointHex</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年9月30日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/posts/2255851676/" title="Effective C++学习笔记">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Effective C++学习笔记</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/posts/2764666242/" title="Effective Modern C++ 笔记">
                        <span class="hidden-mobile">Effective Modern C++ 笔记</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"xnfEeEvX3j8WtgaQfyz6xZ6h-gzGzoHsz","appKey":"UlWK7jpf639GUXTHUzKqoNga","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
